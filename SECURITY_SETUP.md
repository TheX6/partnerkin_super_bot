# Инструкции по безопасной настройке окружения

## Обзор

Этот документ содержит инструкции по безопасной настройке окружения для проекта "Партнеркино" после внедрения улучшений безопасности.

## Критические шаги безопасности

### 1. Установка надежного пароля администратора

**ВАЖНО:** Пароль по умолчанию `partnerkin1212` небезопасен и должен быть изменен немедленно!

1. Создайте надежный пароль, соответствующий следующим требованиям:
   - Минимум 12 символов
   - Содержит заглавные и строчные буквы
   - Содержит цифры
   - Содержит специальные символы (!@#$%^&* и т.д.)

2. Установите новый пароль через переменную окружения:
   ```bash
   # В файле .env
   ADMIN_PASSWORD=ВашНовыйНадежныйПароль123!
   ```

3. Запустите миграцию паролей:
   ```bash
   node scripts/migrateAdminPassword.js --force
   ```

### 2. Настройка базы данных

1. Используйте надежный пароль для PostgreSQL:
   ```bash
   DB_PASSWORD=ВашНадежныйПарольБД
   ```

2. Ограничьте доступ к базе данных:
   - Разрешите подключения только с доверенных IP-адресов
   - Используйте SSL-подключения
   - Создайте отдельного пользователя для приложения с ограниченными правами

3. Регулярно создавайте резервные копии базы данных.

### 3. Защита токена Telegram бота

1. Никогда не публикуйте токен бота в открытом доступе
2. Используйте переменные окружения для хранения токена
3. Регулярно проверяйте активные сессии бота в Telegram
4. При компрометации токена немедленно отозвать его в @BotFather

### 4. Настройка переменных окружения

Обязательные переменные окружения:

```bash
# Токен Telegram бота
TELEGRAM_TOKEN=ВАШ_УНИКАЛЬНЫЙ_ТОКЕН_ЗДЕСЬ

# Надежный пароль администратора
ADMIN_PASSWORD=ВАШ_НАДЕЖНЫЙ_ПАРОЛЬ_АДМИНА

# Параметры базы данных
DB_TYPE=postgresql
DB_HOST=localhost
DB_PORT=5432
DB_NAME=partnerkino
DB_USER=postgres
DB_PASSWORD=ВАШ_НАДЕЖНЫЙ_ПАРОЛЬ

# Дополнительные параметры безопасности
SESSION_SECRET=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ_ДЛЯ_СЕССИЙ
BCRYPT_ROUNDS=12
```

## Процесс безопасного развертывания

### Шаг 1: Подготовка окружения

1. Склонируйте репозиторий в защищенную директорию
2. Скопируйте `.env.example` в `.env`
3. Заполните `.env` файл реальными значениями

### Шаг 2: Установка зависимостей

```bash
npm install --production
```

### Шаг 3: Настройка базы данных

1. Создайте базу данных PostgreSQL
2. Настройте пользователя с ограниченными правами
3. Проверьте подключение к базе данных

### Шаг 4: Миграция безопасности

1. Запустите миграцию паролей администраторов:
   ```bash
   node scripts/migrateAdminPassword.js
   ```

2. Проверьте результат миграции

### Шаг 5: Запуск приложения

```bash
npm start
```

## Рекомендации по безопасности

### 1. Регулярное обновление

- Регулярно обновляйте зависимости проекта
- Следите за уязвимостями в пакетах
- Используйте `npm audit` для проверки безопасности

### 2. Мониторинг

- Настройте логирование безопасности
- Мониторьте попытки входа в админку
- Следите за активностью администраторов

### 3. Резервное копирование

- Регулярно создавайте резервные копии базы данных
- Храните резервные копии в безопасном месте
- Проверяйте процесс восстановления из резервных копий

### 4. Доступ к серверу

- Используйте SSH-ключи вместо паролей
- Ограничьте доступ по IP-адресам
- Настройте файрвол

## Проверка безопасности

### 1. Проверка пароля администратора

```bash
# Проверьте, что пароль не является паролем по умолчанию
node -e "console.log(process.env.ADMIN_PASSWORD === 'partnerkin1212' ? '❌ Используется пароль по умолчанию!' : '✅ Пароль изменен')"
```

### 2. Проверка миграции паролей

```bash
node scripts/migrateAdminPassword.js
```

### 3. Проверка валидации входных данных

Запустите тесты для проверки валидации:
```bash
node -e "
const { validateTelegramId, validateMessageText } = require('./security/inputValidator');
console.log('Тест валидации ID:', validateTelegramId(123456789));
console.log('Тест валидации текста:', validateMessageText('Тестовое сообщение'));
"
```

## В случае компрометации

### 1. Если скомпрометирован пароль администратора

1. Немедленно измените пароль в `.env`
2. Запустите миграцию паролей с флагом `--force`
3. Проверьте логи на предмет подозрительной активности

### 2. Если скомпрометирован токен бота

1. Немедленно отозвать токен в @BotFather
2. Создайте новый токен
3. Обновите `TELEGRAM_TOKEN` в `.env`
4. Перезапустите приложение

### 3. Если скомпрометирована база данных

1. Немедленно измените все пароли
2. Проверьте логи на предмет подозрительной активности
3. Восстановите из чистой резервной копии

## Контакты для связи по вопросам безопасности

При обнаружении уязвимостей безопасности, пожалуйста:
1. Не публикуйте информацию об уязвимости
2. Сообщите о проблеме ответственным лицам
3. Предоставьте подробную информацию о воспроизведении уязвимости

## Дополнительные ресурсы

- [Руководство по безопасности Node.js](https://nodejs.org/en/docs/guides/security/)
- [Руководство по безопасности PostgreSQL](https://www.postgresql.org/docs/current/security.html)
- [Руководство по безопасности Telegram Bot API](https://core.telegram.org/bots/api#security-considerations)